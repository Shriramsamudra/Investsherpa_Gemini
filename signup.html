<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Professional Sign‚Äëup</title>
  <style>
    body {font-family:Arial,sans-serif; max-width:480px; margin:auto; padding:2rem;}
    .field {margin-bottom:1rem;}
    label {display:block; margin-bottom:.25rem;}
    input, select {width:100%; padding:.5rem; border:1px solid #ccc; border-radius:4px;}
    button {padding:.75rem 1.5rem; background:#0069ff; color:#fff; border:none; border-radius:4px; cursor:pointer;}
    .msg {margin-top:1rem; padding:.75rem; border-radius:4px;}
    .error {background:#fdd; color:#900;}
    .success {background:#dfd; color:#060;}
  </style>
  <!-- Load Supabase JS client (you can replace the CDN with a local bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/index.min.js"></script>
</head>
<body>

<h2>Professional Sign‚Äëup</h2>

<form id="signup-form">
  <div class="field">
    <label for="email">Email</label>
    <input type="email" id="email" required />
  </div>

  <div class="field">
    <label for="password">Password</label>
    <input type="password" id="password" required />
  </div>

  <!-- Required fields for professional_profiles -->
  <div class="field">
    <label for="business_name">Business name</label>
    <input type="text" id="business_name" required />
  </div>

  <div class="field">
    <label for="professional_type">Professional type</label>
    <select id="professional_type" required>
      <option value="">Select ‚Ä¶</option>
      <option value="financial_advisor">Financial Advisor</option>
      <option value="insurance_broker">Insurance Broker</option>
      <option value="investment_firm">Investment Firm</option>
      <option value="tax_consultant">Tax Consultant</option>
      <option value="other">Other</option>
    </select>
  </div>

  <button type="submit">Sign up</button>
</form>

<div id="msg" class="msg" style="display:none;"></div>

<script>
// ------------------------------------------------------------------
// 1Ô∏è‚É£  Initialise Supabase client ‚Äì replace with your own keys
// ------------------------------------------------------------------
const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co'; // <-- your project URL
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';               // <-- anon key

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ------------------------------------------------------------------
// 2Ô∏è‚É£  Helper to show status messages
// ------------------------------------------------------------------
function showMessage(text, type = 'error') {
  const el = document.getElementById('msg');
  el.textContent = text;
  el.className = `msg ${type}`;
  el.style.display = 'block';
}

// ------------------------------------------------------------------
// 3Ô∏è‚É£  Main sign‚Äëup flow
// ------------------------------------------------------------------
document.getElementById('signup-form').addEventListener('submit', async (e) => {
  e.preventDefault();          // stop normal form submit
  showMessage('', '');         // clear previous messages

  // ---- gather inputs -------------------------------------------------
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const businessName = document.getElementById('business_name').value.trim();
  const professionalType = document.getElementById('professional_type').value;

  // ---- 1Ô∏è‚É£  Sign‚Äëup user (Auth only) --------------------------------
  const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
    email,
    password,
    options: {
      // optional: you can set a redirect URL after email confirmation
      // emailRedirectTo: 'https://your-site.com/after-confirm'
    }
  });

  if (signUpError) {
    // Auth failed ‚Äì show the error returned by Supabase
    showMessage(`Auth error: ${signUpError.message}`, 'error');
    return;
  }

  // ---- 2Ô∏è‚É£  Wait for the session to be established -------------------
  // In most browsers the session is available immediately after signUp.
  // However, break out if the user is still not logged in.
  const {
    data: { session },
    error: sessionError,
  } = await supabase.auth.getSession();

  if (sessionError || !session) {
    showMessage('Could not obtain a session after sign‚Äëup.', 'error');
    return;
  }

  // ------------------------------------------------------------------
  // 3Ô∏è‚É£  Insert the professional profile using the **authenticated**
  //     client (it has the JWT for auth.uid()).
  // ------------------------------------------------------------------
  const { data: profile, error: profileError } = await supabase
    .from('professional_profiles')
    .insert([
      {
        // user_id will be filled by the trigger `set_professional_user_id`
        business_name: businessName,
        professional_type: professionalType,
        // any other optional columns you want to set can go here
        // e.g. city: 'Delhi', status: 'pending'
      },
    ]);

  if (profileError) {
    // Something went wrong inserting the profile ‚Äì show the DB error message
    showMessage(`Profile insert error: ${profileError.message}`, 'error');
    return;
  }

  // ------------------------------------------------------------------
  // 4Ô∏è‚É£  Success üéâ
  // ------------------------------------------------------------------
  showMessage('‚úÖ Signed up successfully! Your professional profile was created.', 'success');

  // (optional) redirect the user to a dashboard
  // window.location.href = '/dashboard';
});
</script>
</body>
</html>