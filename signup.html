<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Professional Sign‑up</title>
  <style>
    body {font-family:Arial,sans-serif; max-width:480px; margin:auto; padding:2rem;}
    .field {margin-bottom:1rem;}
    label {display:block; margin-bottom:.25rem;}
    input,select {width:100%; padding:.5rem; border:1px solid #ccc; border-radius:4px;}
    button {padding:.75rem 1.5rem; background:#0069ff; color:#fff; border:none; border-radius:4px; cursor:pointer;}
    .msg {margin-top:1rem; padding:.75rem; border-radius:4px; display:none;}
    .error   {background:#fdd; color:#900;}
    .success {background:#dfd; color:#060;}
  </style>
</head>

<body>
<h2>Professional Sign‑up</h2>

<form id="signup-form">
  <div class="field">
    <label for="email">Email</label>
    <input type="email" id="email" required />
  </div>

  <div class="field">
    <label for="password">Password</label>
    <input type="password" id="password" required />
  </div>

  <div class="field">
    <label for="business_name">Business name</label>
    <input type="text" id="business_name" required />
  </div>

  <div class="field">
    <label for="professional_type">Professional type</label>
    <select id="professional_type" required>
      <option value="">Select …</option>
      <option value="financial_advisor">Financial Advisor</option>
      <option value="insurance_broker">Insurance Broker</option>
      <option value="investment_firm">Investment Firm</option>
      <option value="tax_consultant">Tax Consultant</option>
      <option value="other">Other</option>
    </select>
  </div>

  <button type="submit">Sign up</button>
</form>

<div id="msg" class="msg"></div>

<!-- -------------------------------------------------------------
     1️⃣ Load Supabase client as an ES‑module.
     ------------------------------------------------------------- -->
<script type="module">
  // Import the client‑factory from a CDN that serves ES modules
  import { createClient } from "https://esm.run/@supabase/supabase-js@2.44.4";

  // -------------------------------------------------------------
  // 2️⃣ Initialise the client (use a different variable name)
  // -------------------------------------------------------------
  const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co'; // ← your project URL
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';               // ← anon public key

  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // -------------------------------------------------------------
  // 3️⃣ Helper to display status messages
  // -------------------------------------------------------------
  function showMessage(text, type = 'error') {
    const el = document.getElementById('msg');
    el.textContent = text;
    el.className = `msg ${type}`;
    el.style.display = text ? 'block' : 'none';
  }

  // -------------------------------------------------------------
  // 4️⃣ Main flow – sign‑up → (optional) sign‑in → insert profile
  // -------------------------------------------------------------
  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showMessage(''); // clear previous messages

    // ---- gather form data -----------------------------------------
    const email            = document.getElementById('email').value.trim();
    const password         = document.getElementById('password').value;
    const businessName     = document.getElementById('business_name').value.trim();
    const professionalType = document.getElementById('professional_type').value;

    // ---- 1️⃣ Sign‑up (Auth only) ------------------------------------
    const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
      email,
      password,
      options: {
        // If you keep email‑confirmation enabled you can optionally set a redirect:
        // emailRedirectTo: 'https://your‑site.com/after‑confirm'
      }
    });

    if (signUpError) {
      showMessage(`Auth error: ${signUpError.message}`, 'error');
      return;
    }

    // ---- 2️⃣ Get a session (may be null if email‑confirmation is on) ----
    let { data: { session } } = await supabaseClient.auth.getSession();

    // If still no session, sign‑in with the same credentials.
    if (!session) {
      const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
        email,
        password,
      });

      if (signInError) {
        showMessage(`Sign‑in error: ${signInError.message}`, 'error');
        return;
      }
      session = signInData.session;
    }

    if (!session) {
      showMessage('Could not obtain a session after sign‑up/in.', 'error');
      return;
    }

    // ---- 3️⃣ Insert professional profile (authenticated request) ---
    const { data: profile, error: profileError } = await supabaseClient
      .from('professional_profiles')
      .insert([{
        // `user_id` is filled automatically by the trigger `set_professional_user_id`
        business_name: businessName,
        professional_type: professionalType,
        // add any optional columns here
      }]);

    if (profileError) {
      // Shows exact Postgres constraint errors (e.g., NOT NULL violations)
      showMessage(`Profile insert error: ${profileError.message}`, 'error');
      return;
    }

    // ---- 4️⃣ Success ------------------------------------------------
    showMessage('✅ Signed up and professional profile created!', 'success');

    // (optional) redirect to a protected page:
    // window.location.href = '/dashboard';
  });
</script>
</body>
</html>