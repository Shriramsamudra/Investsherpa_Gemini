<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Advisors - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #1e3a8a; color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #1c347d; }
        .card { transition: box-shadow 0.3s ease; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
       <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="p-2 bg-blue-900 rounded-lg"><i class="fas fa-shield-alt text-white text-xl"></i></div>
                <span class="text-2xl font-bold text-blue-900">InvestSherpa.in</span>
            </a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium">Home</a>
                <a href="browselisting.html" class="text-gray-600 hover:text-blue-900 font-medium">Browse</a>
                <a href="#" class="text-gray-600 hover:text-blue-900 font-medium">Blog</a>
            </nav>
            <div class="hidden md:flex items-center space-x-4">
                <a href="login.html" class="text-blue-900 font-semibold hover:underline">Login</a>
                <a href="addlisting.html" class="btn-secondary font-semibold py-2 px-4 rounded-lg shadow-md">List Your Business</a>
            </div>
            <button class="md:hidden text-blue-900 text-2xl"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <aside class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit sticky top-28">
                <h2 class="text-2xl font-bold text-blue-900 mb-6">Filters</h2>
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search by name..." class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <i class="fas fa-search absolute top-1/2 right-3 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-semibold text-gray-700">Category</h3>
                        <div id="filter-categories" class="mt-2 space-y-2 max-h-48 overflow-y-auto pr-2">
                            </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="apply-filters-btn" class="btn-primary w-full py-3 rounded-lg font-bold">Apply Filters</button>
                </div>
            </aside>

            <section class="lg:col-span-3">
                <div class="flex justify-between items-center mb-6">
                    <h1 id="results-count" class="text-3xl font-bold text-blue-900">Loading Results...</h1>
                </div>

                <div id="listings-container" class="grid grid-cols-1 gap-6">
                    </div>
                </section>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const listingsContainer = document.getElementById('listings-container');
        const resultsCountEl = document.getElementById('results-count');
        const searchInput = document.getElementById('search-input');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');

        // --- FETCH AND DISPLAY LISTINGS ---
        async function displayListings() {
            listingsContainer.innerHTML = '<p>Loading...</p>';
            
            let query = supabase
                .from('professional_profiles')
                .select(`
                    id,
                    business_name,
                    city,
                    state,
                    tagline,
                    professional_categories(categories(name))
                `, { count: 'exact' })
                .eq('status', 'approved');

            // --- Apply Search Filter ---
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                query = query.ilike('business_name', `%${searchTerm}%`);
            }
            
            const { data, error, count } = await query;

            if (error) {
                console.error('Error fetching listings:', error);
                listingsContainer.innerHTML = '<p class="text-red-500">Could not load listings.</p>';
                return;
            }

            resultsCountEl.textContent = `Showing ${count} Results`;
            listingsContainer.innerHTML = '';

            if (data.length === 0) {
                listingsContainer.innerHTML = '<p>No advisors found matching your criteria.</p>';
            }

            data.forEach(listing => {
                const categories = listing.professional_categories.map(pc => pc.categories.name).join(', ');

                const card = `
                    <div class="card bg-white rounded-lg shadow-md overflow-hidden flex flex-col md:flex-row">
                        <div class="p-6 flex-grow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold text-blue-900">${listing.business_name}</h3>
                                    <p class="text-gray-600 mb-2"><i class="fas fa-map-marker-alt mr-2"></i>${listing.city}, ${listing.state}</p>
                                </div>
                            </div>
                            <p class="text-gray-700 my-3">${listing.tagline || 'Expert financial and insurance advice.'}</p>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${categories}</span>
                            </div>
                            <a href="listingdetail.html?id=${listing.id}" class="font-semibold text-blue-800 hover:underline">View Profile <i class="fas fa-arrow-right ml-1"></i></a>
                        </div>
                    </div>`;
                listingsContainer.innerHTML += card;
            });
        }

        // --- POPULATE FILTER CATEGORIES ---
        async function populateCategories() {
            const { data, error } = await supabase.from('categories').select('id, name');
            if (error) return;

            const container = document.getElementById('filter-categories');
            container.innerHTML = '';
            data.forEach(cat => {
                const item = `<label class="flex items-center"><input type="checkbox" data-cat-id="${cat.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 mr-2"> ${cat.name}</label>`;
                container.innerHTML += item;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            if (query) {
                searchInput.value = query;
            }
            
            displayListings();
            populateCategories();
            
            applyFiltersBtn.addEventListener('click', displayListings);
        });

    </script>
</body>
</html>