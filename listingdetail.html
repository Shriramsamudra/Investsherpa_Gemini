<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Details - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #1e3a8a; color: white; transition: background-color: 0.3s ease; }
        .btn-primary:hover { background-color: #1c347d; }
        .btn-secondary { background-color: #f59e0b; color: white; transition: background-color: 0.3s ease; }
        .btn-secondary:hover { background-color: #d97706; }
        #map { height: 250px; width: 100%; border-radius: 0.375rem; z-index: 1; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen" x-data="pageData()">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-3">
                <img src="InvestSherpa logo.png" alt="InvestSherpa Logo" class="h-14 w-auto">
                <span class="text-2xl font-bold"><span class="text-blue-900">Invest</span><span class="text-amber-500">Sherpa</span></span>
            </a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium">Home</a>
                <a href="browselisting.html" class="text-gray-600 hover:text-blue-900 font-medium">Browse</a>
                <a href="#" class="text-gray-600 hover:text-blue-900 font-medium">Blog</a>
            </nav>
            <div id="user-actions" class="hidden md:flex items-center space-x-4">
                <template x-if="currentUser">
                    <div class="flex items-center space-x-4">
                        <a href="userprofile.html" x-text="currentUser.email" class="text-gray-600 font-medium hover:text-blue-900 hover:underline text-sm"></a>
                        <button @click="logout()" class="font-semibold text-red-600 hover:underline">Logout</button>
                    </div>
                </template>
                <template x-if="!currentUser">
                    <div class="space-x-4">
                        <a href="login.html" class="text-blue-900 font-semibold hover:underline">Login</a>
                        <a href="addlisting.html" class="btn-secondary font-semibold py-2 px-4 rounded-lg shadow-md">List Your Business</a>
                    </div>
                </template>
            </div>
            <button @click="isMobileMenuOpen = !isMobileMenuOpen" class="md:hidden text-blue-900 text-2xl focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <div x-show="isMobileMenuOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center text-center"
         @click.away="isMobileMenuOpen = false" x-cloak>
        
        <button @click="isMobileMenuOpen = false" class="absolute top-6 right-6 text-gray-800 focus:outline-none">
            <i class="fas fa-times text-3xl"></i>
        </button>

        <nav class="flex flex-col space-y-8 mb-8">
            <a href="index.html" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Home</a>
            <a href="browselisting.html" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Browse</a>
            <a href="#" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Blog</a>
        </nav>

        <div class="border-t w-1/2 my-4"></div>

        <div id="mobile-user-actions" class="flex flex-col items-center space-y-6 mt-8">
             <template x-if="currentUser">
                <div class="flex flex-col items-center space-y-4">
                    <a href="userprofile.html" x-text="currentUser.email" class="text-gray-800 font-bold hover:underline text-lg"></a>
                    <button @click="logout()" class="font-semibold text-red-600 hover:underline text-lg">Logout</button>
                </div>
            </template>
            <template x-if="!currentUser">
                <div class="flex flex-col items-center space-y-6">
                    <a href="login.html" class="text-blue-900 font-bold hover:underline text-xl">Login</a>
                    <a href="addlisting.html" class="btn-secondary text-lg py-3 px-8 rounded-lg shadow-md">List Your Business</a>
                </div>
            </template>
        </div>
    </div>


    <main class="container mx-auto px-6 py-12 flex-grow">
        <div x-show="isLoading" class="text-center py-20">
            <p class="text-xl" x-text="loadingMessage"></p>
        </div>
        
        <div x-show="!isLoading && currentProfile.id" class="grid grid-cols-1 lg:grid-cols-3 gap-8" x-cloak>
            
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col sm:flex-row items-start">
                            <div class="w-28 h-28 rounded-full mr-6 mb-4 sm:mb-0 border-4 border-amber-200 overflow-hidden flex-shrink-0 bg-white">
                                <img :src="currentProfile.logo_url || 'https://placehold.co/112x112/1e3a8a/ffffff?text=Logo'" alt="Business Logo" class="w-full h-full object-contain">
                            </div>
                            <div class="flex-grow">
                                <h1 x-text="currentProfile.business_name" class="text-3xl sm:text-4xl font-bold text-blue-900"></h1>
                                <p x-text="currentProfile.full_name" class="text-gray-500 text-lg"></p>
                                <p x-text="currentProfile.tagline" class="text-gray-600 text-xl mt-2 italic"></p>
                            </div>
                        </div>
                        <a :href="'addlisting.html?id=' + currentProfile.id" class="btn-secondary whitespace-nowrap py-2 px-4 rounded-lg text-sm font-semibold" x-show="isOwner"><i class="fas fa-pencil-alt mr-2"></i> Edit</a>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8 pt-6 border-t">
                        <div class="text-center"><i class="fas fa-briefcase text-2xl text-amber-500"></i><p class="font-semibold mt-1">Experience</p><p x-text="currentProfile.experience_years ? `${currentProfile.experience_years} years` : 'N/A'" class="text-gray-600"></p></div>
                        <div class="text-center"><i class="fas fa-wallet text-2xl text-amber-500"></i><p class="font-semibold mt-1">Fee Structure</p><p x-text="formatFee(currentProfile.fee_structure, currentProfile.fee_amount)" class="text-gray-600"></p></div>
                        <div class="text-center"><i class="fas fa-bolt text-2xl text-amber-500"></i><p class="font-semibold mt-1">Response Time</p><p x-text="currentProfile.response_time || 'N/A'" class="text-gray-600"></p></div>
                        <div class="text-center"><i class="fas fa-video text-2xl text-amber-500"></i><p class="font-semibold mt-1">Video Call</p><p x-text="currentProfile.video_consultation ? 'Available' : 'No'" class="text-gray-600"></p></div>
                    </div>
                </div>

                <div x-show="currentProfile.about" class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-blue-900 mb-4 border-b pb-2">About</h2>
                    <p x-text="currentProfile.about" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></p>
                </div>

                <div x-show="currentProfile.professional_categories && currentProfile.professional_categories.length > 0" class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-blue-900 mb-6 border-b pb-2">Services Offered</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-8">
                        <template x-for="pc in currentProfile.professional_categories" :key="pc.categories.id">
                             <div class="flex items-start space-x-4">
                                <i :class="pc.categories.icon_class || 'fas fa-check-circle'" class="text-3xl text-blue-800 w-8 text-center pt-1"></i>
                                <div><h3 class="font-semibold text-lg" x-text="pc.categories.name"></h3></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="bg-white p-8 rounded-lg shadow-lg">
                     <h2 class="text-2xl font-bold text-blue-900 mb-6 border-b pb-2">Professional Details</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <div x-show="currentProfile.license_info">
                            <h3 class="font-bold text-lg mb-3 text-gray-800">License Information</h3>
                            <ul x-html="formatList(currentProfile.license_info, 'fas fa-certificate', 'text-green-600')" class="space-y-3"></ul>
                         </div>
                         <div x-show="currentProfile.client_focus">
                            <h3 class="font-bold text-lg mb-3 text-gray-800">Client Focus</h3>
                            <ul x-html="formatClientFocusList(currentProfile.client_focus)" class="space-y-3"></ul>
                         </div>
                         <div class="md:col-span-2" x-show="currentProfile.availability">
                             <h3 class="font-bold text-lg mb-3 text-gray-800">Availability</h3>
                             <p x-text="currentProfile.availability" class="text-gray-700"></p>
                         </div>
                     </div>
                </div>
                
                <div x-html="formatLinks(currentProfile.blogs, 'Featured Articles & Blogs', 'fas fa-newspaper')"></div>
                <div x-html="formatLinks(currentProfile.videos, 'Featured Videos', 'fab fa-youtube')"></div>

                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-blue-900 mb-6">Reviews (<span x-text="currentProfile.reviews ? currentProfile.reviews.length : 0"></span>)</h2>
                    <div class="space-y-6">
                        <template x-if="!currentProfile.reviews || currentProfile.reviews.length === 0">
                            <p class="text-gray-500">No reviews yet for this professional.</p>
                        </template>
                        <template x-for="review in currentProfile.reviews" :key="review.id">
                            <div class="border-b pb-4">
                                <div class="flex items-center mb-2">
                                    <div class="review-stars" x-html="getStars(review.rating)"></div>
                                    <p class="ml-4 font-bold text-gray-800" x-text="review.user_profiles.full_name"></p>
                                </div>
                                <p class="text-gray-600 italic" x-text="`&quot;${review.comment}&quot;`"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="canWriteReview" class="bg-white p-8 rounded-lg shadow-lg" @submit-review.window="submitReview()">
                    <h2 class="text-2xl font-bold text-blue-900 mb-4">Write a Review</h2>
                    <form @submit.prevent="$dispatch('submit-review')">
                         <div class="mb-4">
                            <label class="block font-semibold mb-2">Your Rating</label>
                            <div class="review-stars text-3xl" @mouseleave="reviewForm.tempRating = 0">
                                <template x-for="star in 5" :key="star"><i class="fa-star cursor-pointer" :class="((reviewForm.tempRating || reviewForm.rating) >= star) ? 'fa-solid' : 'fa-regular'" @mouseover="reviewForm.tempRating = star" @click="reviewForm.rating = star"></i></template>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="comment" class="block font-semibold mb-2">Your Comment</label>
                            <textarea id="comment" x-model="reviewForm.comment" rows="4" class="w-full p-3 border rounded-lg" required></textarea>
                        </div>
                        <button type="submit" :disabled="reviewForm.submitting" class="btn-primary py-2 px-6 rounded-lg"><span x-text="reviewForm.submitting ? 'Submitting...' : 'Submit Review'"></span></button>
                        <p x-show="reviewForm.message" x-text="reviewForm.message" class="mt-4 font-semibold" :class="reviewForm.messageColor"></p>
                    </form>
                </div>

                <div x-show="hasAlreadyReviewed" class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-blue-900 mb-2">Thank You for Your Feedback</h2>
                    <p class="text-gray-600">You have already submitted a review for this professional.</p>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="space-y-8 sticky top-28">
                    <div class="bg-white p-6 rounded-lg shadow-lg info-card">
                        <button @click="handleConnectClick()" :disabled="isOwner" class="btn-primary w-full py-3 rounded-lg font-bold text-lg mb-6 disabled:opacity-50 disabled:cursor-not-allowed">Connect Now</button>
                        <div class="space-y-4 text-gray-700">
                             <p class="flex items-start" x-show="currentProfile.phone"><i class="fas fa-phone-alt w-6 mt-1 text-amber-500"></i> <a :href="'tel:'+currentProfile.phone" x-text="currentProfile.phone" class="hover:underline"></a></p>
                             <p class="flex items-start" x-show="currentProfile.email"><i class="fas fa-envelope w-6 mt-1 text-amber-500"></i> <a :href="'mailto:'+currentProfile.email" x-text="currentProfile.email" class="hover:underline"></a></p>
                             <p class="flex items-start" x-show="currentProfile.website_url"><i class="fas fa-globe w-6 mt-1 text-amber-500"></i> <a :href="currentProfile.website_url" x-text="getHostname(currentProfile.website_url)" target="_blank" class="hover:underline text-blue-600 break-all"></a></p>
                             <p class="flex items-start" x-show="currentProfile.address"><i class="fas fa-map-marker-alt w-6 mt-1 text-amber-500"></i> <span x-text="`${currentProfile.address}, ${currentProfile.city}`"></span></p>
                        </div>
                        <div class="mt-4 border-t pt-4" x-show="currentProfile.latitude && currentProfile.longitude">
                            <div class="relative">
                                <div id="map"></div>
                                <a :href="'https://www.google.com/maps?q=' + currentProfile.latitude + ',' + currentProfile.longitude"
                                   target="_blank" rel="noopener noreferrer"
                                   class="absolute top-2 right-2 z-10 bg-white py-1 px-3 rounded-md text-sm font-semibold text-blue-700 hover:bg-opacity-100 hover:underline shadow-md transition-all duration-300">
                                   <i class="fas fa-external-link-alt mr-1 text-xs"></i> Google Maps
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg info-card" x-show="currentProfile.service_area">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Service Area</h3>
                        <p x-text="currentProfile.service_area" class="text-gray-700"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div x-show="isConnectModalOpen" @keydown.escape.window="isConnectModalOpen = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100]" x-cloak>
             <div @click.outside="isConnectModalOpen = false" class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 max-h-full overflow-y-auto" @submit-lead.window="handleLeadSubmit()">
                <h2 class="text-2xl font-bold text-blue-900 mb-6">Connect with <span x-text="currentProfile.business_name"></span></h2>
                <form @submit.prevent="$dispatch('submit-lead')">
                    <div class="space-y-4">
                        <div>
                            <label class="font-semibold text-gray-600 text-sm">Your Name</label>
                            <input x-model="lead.name" type="text" required readonly class="w-full p-3 border rounded-lg bg-gray-100 cursor-not-allowed mt-1">
                        </div>
                        <div>
                            <label class="font-semibold text-gray-600 text-sm">Your Email</label>
                            <input x-model="lead.email" type="email" required readonly class="w-full p-3 border rounded-lg bg-gray-100 cursor-not-allowed mt-1">
                        </div>
                        <div>
                             <label class="font-semibold text-gray-600 text-sm">Your Phone</label>
                            <input x-model="lead.phone" type="tel" placeholder="Enter your phone number" required class="w-full p-3 border rounded-lg mt-1">
                        </div>
                        <div>
                            <label class="font-semibold text-gray-600 text-sm">Message</label>
                            <textarea x-model="lead.message" rows="3" placeholder="Your message..." required class="w-full p-3 border rounded-lg mt-1"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end items-center mt-6 space-x-4">
                        <button type="button" @click="isConnectModalOpen = false" class="font-semibold text-gray-600">Cancel</button>
                        <button type="submit" :disabled="sending" class="btn-primary py-2 px-6 rounded-lg"><span x-text="sending ? 'Sending...' : 'Send Request'"></span></button>
                    </div>
                    <p x-text="responseMsg" class="mt-4 text-center text-green-600 font-semibold"></p>
                </form>
            </div>
        </div>
    </main>
    
    <footer class="bg-blue-900 text-white">
        <div class="container mx-auto px-6 py-8 text-center"><p>&copy; 2025 InvestSherpa. All rights reserved.</p></div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('alpine:init', () => {
            Alpine.data('pageData', () => ({
                isLoading: true, loadingMessage: 'Loading profile...',
                currentUser: null, currentUserProfile: null, currentProfile: {}, map: null,
                isMobileMenuOpen: false, // State for mobile menu
                hasAlreadyReviewed: false,
                isConnectModalOpen: false, sending: false, responseMsg: '',
                lead: { name: '', email: '', phone: '', message: '' },
                reviewForm: { rating: 0, tempRating: 0, comment: '', message: '', messageColor: 'text-green-600', submitting: false },
                clientFocusIcons: {'Salaried': 'fas fa-user-tie', 'Professionals': 'fas fa-user-doctor', 'Businessman': 'fas fa-briefcase', 'HNIs': 'fas fa-gem', 'NRIs': 'fas fa-plane-departure', 'Corporate': 'fas fa-building', 'Default': 'fas fa-check-circle'},
                
                get isOwner() { return this.currentUser && this.currentProfile && this.currentUser.id === this.currentProfile.user_id; },
                get canWriteReview() { return this.currentUser && !this.isOwner && !this.hasAlreadyReviewed; },

                async init() {
                    try {
                        supabase.auth.onAuthStateChange((_event, session) => {
                            this.currentUser = session ? session.user : null;
                            this.fetchCurrentUserProfile();
                        });
                        const { data: { session } } = await supabase.auth.getSession();
                        this.currentUser = session ? session.user : null;
                        this.fetchCurrentUserProfile();
                        await this.loadProfile();
                    } catch (err) {
                        console.error("A critical error during page initialization:", err);
                        this.loadingMessage = "Sorry, the page could not be loaded.";
                        this.isLoading = false;
                    }
                },

                fetchCurrentUserProfile() {
                    if (!this.currentUser) { this.currentUserProfile = null; return; }
                    this.currentUserProfile = { full_name: this.currentUser.user_metadata.full_name || 'A user' };
                },

                async logout() { await supabase.auth.signOut(); window.location.reload(); },
                
                async loadProfile() {
                    const profileId = new URLSearchParams(window.location.search).get('id');
                    if (!profileId) { this.loadingMessage = 'Error: No profile ID provided.'; this.isLoading = false; return; }
                    try {
                        const { data, error } = await supabase.from('searchable_profiles').select(`*, professional_categories(categories(*)), reviews(*, user_profiles(full_name))`).eq('id', profileId).eq('status', 'approved').single();
                        if (error || !data) throw new Error("Profile not found or is not approved.");
                        
                        if (data.reviews) {
                            data.reviews = data.reviews.filter(review => review.status === 'approved');
                        }

                        document.title = `${data.business_name} - Details`;
                        this.currentProfile = data;
                        if (this.currentUser && data.reviews) {
                            this.hasAlreadyReviewed = data.reviews.some(review => review.user_id === this.currentUser.id);
                        }
                        if (data.latitude && data.longitude) { this.$nextTick(() => this.initializeMap(data.latitude, data.longitude)); }
                    } catch (e) { this.loadingMessage = e.message; } finally { this.isLoading = false; }
                },

                initializeMap(lat, lng) {
                    if (this.map) this.map.remove();
                    this.map = L.map('map').setView([lat, lng], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                    L.marker([lat, lng]).addTo(this.map).bindPopup(this.currentProfile.business_name).openPopup();
                    
                    // FIX: Force map to recalculate its size after the container is visible
                    setTimeout(() => {
                        this.map.invalidateSize();
                    }, 100);
                },
                
                handleConnectClick() {
                    if (!this.currentUser) { alert('Please log in to connect.'); } 
                    else if (this.isOwner) { alert("You cannot connect with your own profile."); } 
                    else {
                        this.lead.name = this.currentUserProfile?.full_name || '';
                        this.lead.email = this.currentUser?.email || '';
                        this.lead.phone = ''; this.lead.message = '';
                        this.isConnectModalOpen = true;
                    }
                },
                
                formatFee(structure, amount) {
                    if (!structure) return 'N/A';
                    if (structure === 'Per Consultation' && amount) return `₹${amount}`;
                    return structure;
                },
                getHostname(url) {
                    if (!url) return '';
                    try { let fullUrl = url.startsWith('http') ? url : `https://${url}`; return new URL(fullUrl).hostname; } 
                    catch (e) { return url; }
                },
                getStars(rating) { return '<i class="fas fa-star text-amber-500"></i>'.repeat(rating) + '<i class="far fa-star text-gray-300"></i>'.repeat(5 - rating); },
                formatList(csv, icon, iconColor = 'text-green-600') {
                    if (!csv) return '';
                    return csv.split(',').map(item => `<li class="flex items-start"><i class="${icon} w-6 ${iconColor} mt-1"></i><span>${item.trim()}</span></li>`).join('');
                },
                formatClientFocusList(csv) {
                    if (!csv) return '';
                    return csv.split(',').map(itemText => {
                        const text = itemText.trim();
                        const icon = this.clientFocusIcons[text] || this.clientFocusIcons['Default'];
                        return `<li class="flex items-start"><i class="${icon} w-6 text-green-600 mt-1"></i><span>${text}</span></li>`;
                    }).join('');
                },
                formatLinks(links, title, icon) {
                    if (!links || links.length === 0) return '';
                    let content = `<div class="bg-white p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-blue-900 mb-6 border-b pb-2">${title}</h2><div class="space-y-4">`;
                    links.forEach(link => { content += `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-3 group"><i class="${icon} text-2xl text-blue-800"></i><span class="font-medium group-hover:underline">${link.title}</span></a>`; });
                    return content + '</div></div>';
                },
                
                async handleLeadSubmit() {
                    this.sending = true; this.responseMsg = '';
                    const { error: insertError } = await supabase.from('leads').insert({ profile_id: this.currentProfile.id, name: this.lead.name, email: this.lead.email, phone: this.lead.phone, message: this.lead.message });
                    if (insertError) { console.error('Error submitting lead:', insertError); this.responseMsg = 'There was an error sending your request.'; this.sending = false; return; }
                    const { error: functionError } = await supabase.functions.invoke('send-lead-email', { body: { professionalEmail: this.currentProfile.email, professionalName: this.currentProfile.full_name, lead: this.lead } });
                    if (functionError) console.error('Error calling email function:', functionError);
                    this.responseMsg = 'Your request has been sent successfully!';
                    setTimeout(() => { this.isConnectModalOpen = false; this.responseMsg = ''; this.lead = { name: '', email: '', phone: '', message: '' }; this.sending = false; }, 2000);
                },
                async submitReview() {
                    if (!this.reviewForm.rating || !this.reviewForm.comment) { this.reviewForm.message = 'Please provide a rating and a comment.'; this.reviewForm.messageColor = 'text-red-600'; return; }
                    this.reviewForm.submitting = true; this.reviewForm.message = '';
                    const { error: insertError } = await supabase.from('reviews').insert({ profile_id: this.currentProfile.id, user_id: this.currentUser.id, rating: this.reviewForm.rating, comment: this.reviewForm.comment, status: 'pending' });
                    if (insertError) { console.error('Error submitting review:', insertError); this.reviewForm.message = 'Sorry, there was an error submitting your review.'; this.reviewForm.messageColor = 'text-red-600'; this.reviewForm.submitting = false; return; }
                    const { error: functionError } = await supabase.functions.invoke('notify-new-review', { body: { professionalEmail: this.currentProfile.email, professionalName: this.currentProfile.full_name, reviewerName: this.currentUserProfile?.full_name || 'A user' } });
                    if (functionError) console.error('Error calling review notification function:', functionError);
                    this.reviewForm.message = 'Thank you! Your review has been submitted for approval.';
                    this.reviewForm.messageColor = 'text-green-600';
                    this.hasAlreadyReviewed = true;
                    setTimeout(() => { Object.assign(this.reviewForm, { rating: 0, tempRating: 0, comment: '', message: '', submitting: false }); }, 3000);
                }
            }));
        });
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>