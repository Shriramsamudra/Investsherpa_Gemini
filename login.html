<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login or Sign Up - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-bg {
            background-color: #f0f7ff;
        }
        .btn-primary {
            background-color: #1e3a8a;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #1c347d;
        }
        .btn-primary:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #f59e0b;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #e4900a;
        }
         [x-cloak] { display: none !important; }
        .form-message {
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-align: center;
        }
        .form-message.success {
            display: block;
            background-color: #d1fae5;
            color: #065f46;
        }
        .form-message.error {
            display: block;
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800" x-data="{ isMobileMenuOpen: false }">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-3">
                <img src="InvestSherpa logo.png" alt="InvestSherpa Logo" class="h-14 w-auto">
                <span class="text-2xl font-bold">
                    <span class="text-blue-900">Invest</span><span class="text-amber-500">Sherpa</span>
                </span>
            </a>
            
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium">Home</a>
                <a href="browselisting.html" class="text-gray-600 hover:text-blue-900 font-medium">Browse</a>
            </nav>

            <div class="hidden md:flex items-center space-x-4">
                <a href="login.html" class="text-blue-900 font-semibold hover:underline">Login</a>
                <a href="addlisting.html" class="btn-secondary font-semibold py-2 px-4 rounded-lg shadow-md">List Your Business</a>
            </div>
            
            <button @click="isMobileMenuOpen = !isMobileMenuOpen" class="md:hidden text-blue-900 text-2xl focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <div x-show="isMobileMenuOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center space-y-8"
         @click.away="isMobileMenuOpen = false" x-cloak>
        
        <button @click="isMobileMenuOpen = false" class="absolute top-6 right-6 text-gray-800 focus:outline-none">
            <i class="fas fa-times text-3xl"></i>
        </button>

        <a href="index.html" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Home</a>
        <a href="browselisting.html" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Browse</a>
        <div class="border-t w-1/2 my-4"></div>
        <a href="login.html" @click="isMobileMenuOpen = false" class="text-xl text-blue-900 font-semibold hover:underline">Login</a>
        <a href="addlisting.html" @click="isMobileMenuOpen = false" class="btn-secondary text-lg py-3 px-8 rounded-lg shadow-md">List Your Business</a>
    </div>


    <main class="flex items-center justify-center min-h-[calc(100vh-80px)] py-12 px-4 form-bg">
        <div class="w-full max-w-md" x-data="{ isLogin: true, userRole: 'end_user' }">
            
            <div x-show="isLogin" x-cloak class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-blue-900 mb-6">Welcome Back!</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="login-email" name="email" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <a href="#" class="text-sm text-blue-600 hover:underline">Forgot?</a>
                        </div>
                        <input type="password" id="login-password" name="password" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <button type="submit" class="w-full btn-primary font-bold py-3 px-6 rounded-lg shadow-md">Login</button>
                        <div id="form-message-box-login" class="form-message mt-4"></div>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Don't have an account? 
                    <button @click="isLogin = false; document.getElementById('form-message-box-login').className = 'form-message';" class="font-semibold text-blue-600 hover:underline">Sign Up</button>
                </p>
            </div>

            <div x-show="!isLogin" x-cloak class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-blue-900 mb-6">Create Your Account</h2>
                <form id="signup-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <label class="flex items-center p-3 border rounded-lg cursor-pointer" :class="{ 'bg-blue-50 border-blue-500': userRole === 'end_user' }">
                            <input type="radio" name="role" value="end_user" x-model="userRole" class="hidden">
                            <i class="fas fa-user text-xl text-blue-800 mr-3"></i>
                            <div>
                                <span class="font-semibold">I'm an End User</span>
                                <p class="text-xs text-gray-500">Seeking an advisor.</p>
                            </div>
                         </label>
                         <label class="flex items-center p-3 border rounded-lg cursor-pointer" :class="{ 'bg-blue-50 border-blue-500': userRole === 'professional' }">
                            <input type="radio" name="role" value="professional" x-model="userRole" class="hidden">
                             <i class="fas fa-briefcase text-xl text-blue-800 mr-3"></i>
                             <div>
                                <span class="font-semibold">I'm a Professional</span>
                                <p class="text-xs text-gray-500">Listing my service.</p>
                             </div>
                         </label>
                    </div>
                    
                    <input type="text" name="full_name" placeholder="Full Name" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <input type="email" name="email" placeholder="Email Address" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <input type="password" name="password" placeholder="Create Password" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <input type="tel" name="phone" placeholder="Phone Number" required class="w-full p-3 border border-gray-300 rounded-lg">

                    <div x-show="userRole === 'professional'" x-collapse class="space-y-4 pt-2">
                        <hr>
                        <p class="text-sm font-semibold text-gray-700 text-center">Professional Information</p>
                        <input type="text" name="business_name" placeholder="Business Name (Optional)" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                        <input type="text" name="city" placeholder="City" required class="w-full p-3 border border-gray-300 rounded-lg">
                        <select id="state-select" name="state" required class="w-full p-3 border border-gray-300 rounded-lg text-gray-500">
                            <option value="" disabled selected>Select State</option>
                            </select>
                    </div>
                     <input type="text" name="pincode" placeholder="Pincode" required class="w-full p-3 border border-gray-300 rounded-lg">

                    <div>
                        <button type="submit" id="signup-button" class="w-full btn-primary font-bold py-3 px-6 rounded-lg shadow-md mt-4">
                            <span class="button-text">Create Account</span>
                            <i class="fas fa-spinner fa-spin button-loader hidden"></i>
                        </button>
                        <div id="form-message-box-signup" class="form-message mt-4"></div>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Already have an account? 
                    <button @click="isLogin = true; document.getElementById('form-message-box-signup').className = 'form-message';" class="font-semibold text-blue-600 hover:underline">Login</button>
                </p>
            </div>
        </div>
    </main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const states = [ "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry" ];
        const stateSelect = document.getElementById('state-select');
        if (stateSelect) {
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        }

        const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const loginMessageBox = document.getElementById('form-message-box-login');
        const signupMessageBox = document.getElementById('form-message-box-signup');
        
        const showMessage = (box, message, type = 'error') => {
            box.textContent = message;
            box.className = `form-message ${type}`;
        };
        
        // --- LOGIN FORM LOGIC ---
        document.getElementById('login-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const email = form.email.value;
            const password = form.password.value;
            form.querySelector('button').disabled = true;

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showMessage(loginMessageBox, error.message);
                form.querySelector('button').disabled = false;
            } else if (data.user) {
                showMessage(loginMessageBox, 'Login successful! Redirecting...', 'success');
                
                setTimeout(async () => {
                    const userRole = data.user.user_metadata.role;

                    if (userRole === 'professional') {
                        window.location.href = 'addlisting.html';
                    } else {
                        window.location.href = 'browselisting.html';
                    }
                }, 1500);
            }
        });

        // --- SIGNUP FORM LOGIC ---
        const signupForm = document.getElementById('signup-form');
        const signupButton = document.getElementById('signup-button');

        signupForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            signupButton.disabled = true;
            signupButton.querySelector('.button-text').classList.add('hidden');
            signupButton.querySelector('.button-loader').classList.remove('hidden');
            showMessage(signupMessageBox, '', 'success');

            const formData = new FormData(signupForm);
            const email = formData.get('email');
            const password = formData.get('password');
            const role = formData.get('role');

            const userMetadata = {
                role: role,
                full_name: formData.get('full_name'),
                phone: formData.get('phone'),
                city: formData.get('city'),
                state: formData.get('state'),
                pincode: formData.get('pincode'),
            };
            
            if (role === 'professional') {
                userMetadata.business_name = formData.get('business_name');
            }

            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: userMetadata
                }
            });

            if (error) {
                showMessage(signupMessageBox, error.message);
            } else if (data.user) {
                const isNewUser = (new Date() - new Date(data.user.created_at)) < 2000;
                
                if (isNewUser) {
                    showMessage(signupMessageBox, 'Sign up successful! Please check your email to verify your account.', 'success');
                } else {
                    showMessage(signupMessageBox, 'This email is already pending confirmation. We have re-sent a verification link to your inbox.', 'success');
                }
                signupForm.reset();
            }
            
            signupButton.disabled = false;
            signupButton.querySelector('.button-text').classList.remove('hidden');
            signupButton.querySelector('.button-loader').classList.add('hidden');
        });
    });
</script>
</body>
</html>