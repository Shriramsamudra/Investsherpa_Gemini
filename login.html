<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login or Sign Up - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-bg {
            background-color: #f0f7ff;
        }
        .btn-primary {
            background-color: #1e3a8a;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #1c347d;
        }
        .btn-primary:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #f59e0b;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #e4900a;
        }
         [x-cloak] { display: none !important; }
        .form-message {
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-align: center;
        }
        .form-message.success {
            display: block;
            background-color: #d1fae5;
            color: #065f46;
        }
        .form-message.error {
            display: block;
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="p-2 bg-blue-900 rounded-lg">
                    <i class="fas fa-shield-alt text-white text-xl"></i>
                </div>
                <span class="text-2xl font-bold text-blue-900">InvestSherpa.in</span>
            </a>
            
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium">Home</a>
                <a href="browselisting.html" class="text-gray-600 hover:text-blue-900 font-medium">Browse</a>
            </nav>

            <div class="hidden md:flex items-center space-x-4">
                <a href="login.html" class="text-blue-900 font-semibold hover:underline">Login</a>
                <a href="addlisting.html" class="btn-secondary font-semibold py-2 px-4 rounded-lg shadow-md">List Your Business</a>
            </div>
            
            <button class="md:hidden text-blue-900 text-2xl">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <main class="flex items-center justify-center min-h-screen py-12 form-bg">
        <div class="w-full max-w-md" x-data="{ isLogin: true, userRole: 'end_user' }">
            
            <div x-show="isLogin" x-cloak class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-blue-900 mb-6">Welcome Back!</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="login-email" name="email" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <a href="#" class="text-sm text-blue-600 hover:underline">Forgot?</a>
                        </div>
                        <input type="password" id="login-password" name="password" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <button type="submit" class="w-full btn-primary font-bold py-3 px-6 rounded-lg shadow-md">Login</button>
                        <div id="form-message-box-login" class="form-message mt-4"></div>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Don't have an account? 
                    <button @click="isLogin = false; document.getElementById('form-message-box-login').className = 'form-message';" class="font-semibold text-blue-600 hover:underline">Sign Up</button>
                </p>
            </div>

            <div x-show="!isLogin" x-cloak class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-blue-900 mb-6">Create Your Account</h2>
                <form id="signup-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                         <label class="flex items-center p-3 border rounded-lg cursor-pointer" :class="{ 'bg-blue-50 border-blue-500': userRole === 'end_user' }">
                            <input type="radio" name="role" value="end_user" x-model="userRole" class="hidden">
                            <i class="fas fa-user text-xl text-blue-800 mr-3"></i>
                            <div>
                                <span class="font-semibold">I'm an End User</span>
                                <p class="text-xs text-gray-500">Seeking an advisor.</p>
                            </div>
                         </label>
                         <label class="flex items-center p-3 border rounded-lg cursor-pointer" :class="{ 'bg-blue-50 border-blue-500': userRole === 'professional' }">
                            <input type="radio" name="role" value="professional" x-model="userRole" class="hidden">
                             <i class="fas fa-briefcase text-xl text-blue-800 mr-3"></i>
                             <div>
                                <span class="font-semibold">I'm a Professional</span>
                                <p class="text-xs text-gray-500">Listing my service.</p>
                             </div>
                         </label>
                    </div>
                    
                    <input type="text" name="full_name" placeholder="Full Name" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <input type="email" name="email" placeholder="Email Address" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <input type="password" name="password" placeholder="Create Password" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <input type="tel" name="phone" placeholder="Phone Number" required class="w-full p-3 border border-gray-300 rounded-lg">

                    <div x-show="userRole === 'professional'" x-collapse class="space-y-4 pt-2">
                        <hr>
                        <p class="text-sm font-semibold text-gray-700 text-center">Professional Information</p>
                        <input type="text" name="company_name" placeholder="Company Name" x-bind:required="userRole === 'professional'" class="w-full p-3 border border-gray-300 rounded-lg">
                        <select name="professional_type" x-bind:required="userRole === 'professional'" class="w-full p-3 border border-gray-300 rounded-lg text-gray-500">
                            <option value="" disabled selected>Select Professional Type</option>
                            <option value="financial_advisor">Financial Advisor</option>
                            <option value="insurance_broker">Insurance Broker</option>
                            <option value="investment_firm">Investment Firm</option>
                            <option value="tax_consultant">Tax Consultant</option>
                            <option value="other">Other</option>
                        </select>
                        <hr>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                        <input type="text" name="city" placeholder="City" required class="w-full p-3 border border-gray-300 rounded-lg">
                        <select id="state-select" name="state" required class="w-full p-3 border border-gray-300 rounded-lg text-gray-500">
                            <option value="" disabled selected>Select State</option>
                            </select>
                    </div>
                     <input type="text" name="pincode" placeholder="Pincode" required class="w-full p-3 border border-gray-300 rounded-lg">

                    <div>
                        <button type="submit" id="signup-button" class="w-full btn-primary font-bold py-3 px-6 rounded-lg shadow-md mt-4">
                            <span class="button-text">Create Account</span>
                            <i class="fas fa-spinner fa-spin button-loader hidden"></i>
                        </button>
                        <div id="form-message-box-signup" class="form-message mt-4"></div>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Already have an account? 
                    <button @click="isLogin = true; document.getElementById('form-message-box-signup').className = 'form-message';" class="font-semibold text-blue-600 hover:underline">Login</button>
                </p>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const SUPABASE_URL = 'https://tapnnlkokcbzckbbdxez.supabase.co';
            [cite_start]// MODIFICATION 2: The incorrect API key was replaced with the correct one. [cite: 2]
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhcG5ubGtva2NiemNrYmJkeGV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1Mzc4NDEsImV4cCI6MjA2OTExMzg0MX0.ks3HUfeA-KNJmsgKNhb5xYlv-VXkZkRJC-3EG6D6R-w';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const loginMessageBox = document.getElementById('form-message-box-login');
            const signupMessageBox = document.getElementById('form-message-box-signup');
            
            const showMessage = (box, message, type = 'error') => {
                box.textContent = message;
                box.className = `form-message ${type}`;
            };
            
            const states = [ "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry" ];
            const stateSelect = document.getElementById('state-select');
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
            
            // --- LOGIN FORM ---
            document.getElementById('login-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const form = event.target;
                const email = form.email.value;
                const password = form.password.value;

                const { data, error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    showMessage(loginMessageBox, error.message);
                } else {
                    showMessage(loginMessageBox, 'Login successful! Redirecting...', 'success');
                    console.log('Logged in user:', data.user);
                    // You would typically redirect the user here, e.g., window.location.href = '/dashboard.html';
                }
            });

            // --- SIGNUP FORM ---
            const signupForm = document.getElementById('signup-form');
            const signupButton = document.getElementById('signup-button');

            signupForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                signupButton.disabled = true;
                signupButton.querySelector('.button-text').classList.add('hidden');
                signupButton.querySelector('.button-loader').classList.remove('hidden');
                signupMessageBox.className = 'form-message';

                const formData = new FormData(signupForm);
                const email = formData.get('email');
                const password = formData.get('password');
                const role = formData.get('role');

                // Step 1: Sign up the user with Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });

                if (authError) {
                    showMessage(signupMessageBox, authError.message);
                } else if (authData.user) {
                    // Step 2: Insert the profile information into the 'user_profiles' table
                    const { error: profileError } = await supabase
                        .from('user_profiles')
                        .insert([{
                            id: authData.user.id,
                            email: email,
                            full_name: formData.get('full_name'),
                            phone: formData.get('phone'),
                            city: formData.get('city'),
                            state: formData.get('state'),
                            pincode: formData.get('pincode'),
                            role: role
                        }]);

                    if (profileError) {
                        // This error might happen due to RLS policies or database constraints.
                        console.error('Supabase Profile Error:', profileError);
                        showMessage(signupMessageBox, `Could not save user profile: ${profileError.message}`);
                    } else {
                        // Step 3 (Conditional): If the user is a professional, create a professional profile
                        if (role === 'professional') {
                            const { error: profProfileError } = await supabase
                                .from('professional_profiles')
                                .insert([{
                                    user_id: authData.user.id,
                                    company_name: formData.get('company_name'),
                                    professional_type: formData.get('professional_type'),
                                    status: 'pending'
                                }]);
                            
                            if (profProfileError) {
                                console.error('Supabase Professional Profile Error:', profProfileError);
                                showMessage(signupMessageBox, `User account created, but professional profile failed: ${profProfileError.message}`);
                            }
                        }
                        
                        // If everything is successful
                        if (!profileError && !(role === 'professional' && profProfileError)) {
                            showMessage(signupMessageBox, 'Sign up successful! Please check your email to verify your account.', 'success');
                            signupForm.reset();
                        }
                    }
                }
                
                // Re-enable the button
                signupButton.disabled = false;
                signupButton.querySelector('.button-text').classList.remove('hidden');
                signupButton.querySelector('.button-loader').classList.add('hidden');
            });
        });
    </script>
</body>
</html>