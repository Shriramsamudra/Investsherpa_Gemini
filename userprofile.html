<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn { display: inline-flex; align-items: center; justify-content: center; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #1e3a8a; color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #1c347d; }
        .btn-secondary { background-color: #6b7280; color: white; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #dc2626; color: white; transition: background-color 0.3s ease; }
        .btn-danger:hover { background-color: #b91c1c; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="p-2 bg-blue-900 rounded-lg"><i class="fas fa-shield-alt text-white text-xl"></i></div>
                <span class="text-2xl font-bold text-blue-900">InvestSherpa.in</span>
            </a>
            <div id="user-actions" class="hidden md:flex items-center space-x-4">
                 <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium">Home</a>
                 <a href="browselisting.html" class="text-gray-600 hover:text-blue-900 font-medium">Browse</a>
                 <button id="logout-button" class="btn btn-secondary text-sm">Logout</button>
            </div>
            <button class="md:hidden text-blue-900 text-2xl"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div id="loading-state" class="text-center py-16">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg text-gray-600">Loading your profile...</p>
        </div>
        
        <section id="profile-section" class="hidden">
            <div class="max-w-3xl mx-auto bg-white p-8 sm:p-10 rounded-xl shadow-xl">
                <h2 class="text-3xl font-bold text-blue-900 mb-2">My Profile</h2>
                <p class="text-gray-600 mb-8">View and update your personal information.</p>
                
                <form id="profile-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <label for="full_name" class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" id="full_name" name="full_name" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="email" name="email" readonly class="w-full p-3 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                         <div>
                            <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                            <input type="text" id="city" name="city" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                            <select id="state" name="state" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Select your state</option>
                            </select>
                        </div>
                         <div>
                            <label for="pincode" class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
                            <input type="text" id="pincode" name="pincode" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div id="form-message" class="hidden mt-6 p-4 rounded-md w-full"></div>

                    <div class="border-t pt-6 flex flex-col sm:flex-row items-center justify-end space-y-3 sm:space-y-0 sm:space-x-4">
                        <a href="index.html" class="btn btn-secondary w-full sm:w-auto">Cancel</a>
                        <button type="submit" id="save-button" class="btn btn-primary w-full sm:w-auto">
                            <span id="save-button-text">Save Changes</span>
                            <span id="save-spinner" class="hidden loader"></span>
                        </button>
                    </div>
                </form>

                <div class="border-t mt-10 pt-6">
                    <h3 class="text-xl font-bold text-red-800">Danger Zone</h3>
                    <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                        <p class="text-gray-600 max-w-lg mb-4 sm:mb-0">Deleting your account is permanent and cannot be undone. All associated data will be removed.</p>
                        <button id="delete-button" class="btn btn-danger flex-shrink-0">Delete My Account</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        
        const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Elements ---
        const loadingState = document.getElementById('loading-state');
        const profileSection = document.getElementById('profile-section');
        const userActions = document.getElementById('user-actions');
        const form = document.getElementById('profile-form');
        const messageEl = document.getElementById('form-message');
        const saveButton = document.getElementById('save-button');
        const saveButtonText = document.getElementById('save-button-text');
        const saveSpinner = document.getElementById('save-spinner');
        const logoutButton = document.getElementById('logout-button');
        const deleteButton = document.getElementById('delete-button');
        const stateSelect = document.getElementById('state');
        
        // --- State ---
        let currentUser = null;
        
        const indianStates = [ "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry" ];
        
        function populateStates() {
            indianStates.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        }

        function showMessage(text, type) {
            messageEl.textContent = text;
            messageEl.className = `p-4 rounded-md text-center w-full ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
        }

        function setLoading(isLoading) {
            if (isLoading) {
                saveButton.disabled = true;
                saveButtonText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');
                messageEl.className = 'hidden';
            } else {
                saveButton.disabled = false;
                saveButtonText.classList.remove('hidden');
                saveSpinner.classList.add('hidden');
            }
        }

        async function loadUserProfile(user) {
            const { data: profile, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (error) {
                console.error("Error fetching profile:", error);
                showMessage("Could not fetch your profile data. Please try again later.", "error");
                loadingState.innerHTML = '<p class="text-red-500">Error loading profile.</p>';
                return;
            }

            if (profile) {
                document.getElementById('full_name').value = profile.full_name || '';
                document.getElementById('email').value = profile.email || user.email;
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('city').value = profile.city || '';
                document.getElementById('state').value = profile.state || '';
                document.getElementById('pincode').value = profile.pincode || '';
            }

            loadingState.classList.add('hidden');
            profileSection.classList.remove('hidden');
        }

        // --- Event Handlers ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            const formData = new FormData(form);
            const updates = {
                full_name: formData.get('full_name'),
                phone: formData.get('phone'),
                city: formData.get('city'),
                state: formData.get('state'),
                pincode: formData.get('pincode'),
                updated_at: new Date().toISOString()
            };

            const { error } = await supabase
                .from('user_profiles')
                .update(updates)
                .eq('id', currentUser.id);

            if (error) {
                showMessage(`Error updating profile: ${error.message}`, 'error');
            } else {
                showMessage('Profile updated successfully!', 'success');
            }
            setLoading(false);
        });

        logoutButton.addEventListener('click', async () => {
            await supabase.auth.signOut();
        });

        deleteButton.addEventListener('click', async () => {
            const isConfirmed = confirm('Are you sure you want to delete your account? This action is irreversible.');
            if (isConfirmed) {
                // IMPORTANT: Securely deleting a user requires a server-side call.
                // This code calls a Postgres Function named `delete_user_account`.
                // You must create this function in your Supabase SQL Editor.
                // See documentation for creating functions with `security_definer`.
                // Example function:
                // CREATE FUNCTION delete_user_account()
                // RETURNS void AS $$
                // BEGIN
                //   DELETE FROM auth.users WHERE id = auth.uid();
                // END;
                // $$ LANGUAGE plpgsql SECURITY DEFINER;
                
                const { error } = await supabase.rpc('delete_user_account');

                if (error) {
                    alert(`Error deleting account: ${error.message}. Please contact support.`);
                } else {
                    alert('Account deleted successfully.');
                    window.location.href = 'index.html';
                }
            }
        });

        async function initializePage(user) {
            currentUser = user;
            userActions.classList.remove('hidden');
            await loadUserProfile(user);
        }

        // --- Auth Check on Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            populateStates();
            const { data: { session }, error } = await supabase.auth.getSession();

            if (session) {
                await initializePage(session.user);
            } else {
                window.location.href = 'login.html';
            }

            supabase.auth.onAuthStateChange((_event, session) => {
                if (!session) {
                    window.location.href = 'login.html';
                }
            });
        });
    </script>
</body>
</html>