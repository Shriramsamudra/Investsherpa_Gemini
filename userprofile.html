<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #1e3a8a; color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #1c347d; }
        .btn-secondary { background-color: #f59e0b; color: white; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #d97706; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800" x-data="userProfile">

    <header class="bg-white shadow-sm sticky top-0 z-50">
       <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-3">
                <img src="InvestSherpa logo.png" alt="InvestSherpa Logo" class="h-14 w-auto">
                <span class="text-2xl font-bold">
                    <span class="text-blue-900">Invest</span><span class="text-amber-500">Sherpa</span>
                </span>
            </a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium">Home</a>
                <a href="browselisting.html" class="text-gray-600 hover:text-blue-900 font-medium">Browse</a>
                <a href="#" class="text-gray-600 hover:text-blue-900 font-medium">Blog</a>
            </nav>
            <div id="user-actions" class="hidden md:flex items-center space-x-4">
                </div>
            <button class="md:hidden text-blue-900 text-2xl"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main class="container mx-auto max-w-2xl px-6 py-12">
        <div x-show="!loading" x-cloak class="bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b pb-4">Your Profile</h2>

            <form @submit.prevent="updateProfile" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <div class="mt-1">
                        <input type="email" id="email" x-model="user.email" disabled class="w-full p-3 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>

                <div>
                    <label for="full_name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <div class="mt-1">
                        <input type="text" id="full_name" x-model="profile.full_name" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <div class="mt-1">
                        <input type="tel" id="phone" x-model="profile.phone" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                        <div class="mt-1">
                            <input type="text" id="city" x-model="profile.city" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                     <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">Pincode</label>
                        <div class="mt-1">
                            <input type="text" id="pincode" x-model="profile.pincode" maxlength="6" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                 <div>
                    <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                    <div class="mt-1">
                        <input type="text" id="state" x-model="profile.state" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div x-show="message.text" :class="message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="p-4 rounded-md text-center" x-text="message.text"></div>

                <div class="flex justify-between items-center pt-4">
                    <a href="#" @click.prevent="resetPassword" class="text-sm font-semibold text-blue-800 hover:underline">Reset Password</a>
                    
                    <button type="submit" :disabled="submitting" class="btn-primary font-bold py-2 px-6 rounded-lg shadow-md disabled:opacity-50 flex items-center justify-center ml-auto">
                        <i x-show="submitting" class="fas fa-spinner fa-spin mr-2"></i>
                        <span x-text="submitting ? 'Saving...' : 'Save Changes'"></span>
                    </button>
                </div>
            </form>
        </div>

        <div x-show="loading" class="text-center py-20">
            <p class="text-xl text-gray-600">Loading your profile...</p>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- User Authentication UI Logic for Header ---
        const userActionsContainer = document.getElementById('user-actions');

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        function updateUserUI(user) {
            userActionsContainer.innerHTML = ''; // Clear previous content
            if (user) {
                userActionsContainer.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <a href="userprofile.html" class="text-gray-600 font-medium hover:text-blue-900 hover:underline text-sm">${user.email}</a>
                        <button id="logout-btn" class="font-semibold text-red-600 hover:underline">Logout</button>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
            } else {
                userActionsContainer.innerHTML = `
                    <a href="login.html" class="text-blue-900 font-semibold hover:underline">Login</a>
                    <a href="addlisting.html" class="btn-secondary font-semibold py-2 px-4 rounded-lg shadow-md">List Your Business</a>
                `;
            }
        }
        // --- End of Auth UI Logic ---

        document.addEventListener('alpine:init', () => {
            Alpine.data('userProfile', () => ({
                loading: true,
                submitting: false,
                user: null,
                profile: { full_name: '', phone: '', city: '', state: '', pincode: '' },
                message: { text: '', type: '' },

                async init() {
                    supabase.auth.onAuthStateChange((_event, session) => {
                        updateUserUI(session ? session.user : null);
                        if (!session) {
                            window.location.href = 'login.html';
                        } else {
                            this.user = session.user;
                            this.loadProfile();
                        }
                    });
                },

                async loadProfile() {
                    this.loading = true;
                    try {
                        const { data, error } = await supabase
                            .from('user_profiles')
                            .select('full_name, phone, city, state, pincode')
                            .eq('id', this.user.id)
                            .single();
                        
                        if (error && error.code !== 'PGRST116') { // PGRST116 = row not found
                           throw error;
                        }

                        if (data) {
                            this.profile = data;
                        }
                    } catch (error) {
                        this.showMessage('Error loading profile: ' + error.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async updateProfile() {
                    this.submitting = true;
                    this.message.text = '';
                    try {
                        const { error } = await supabase
                            .from('user_profiles')
                            .update({
                                full_name: this.profile.full_name,
                                phone: this.profile.phone,
                                city: this.profile.city,
                                state: this.profile.state,
                                pincode: this.profile.pincode,
                            })
                            .eq('id', this.user.id);
                        
                        if (error) throw error;

                        this.showMessage('Profile updated successfully!', 'success');
                    } catch (error) {
                        this.showMessage('Error updating profile: ' + error.message, 'error');
                    } finally {
                        this.submitting = false;
                    }
                },

                async resetPassword() {
                    this.submitting = true; // prevent other actions
                    this.showMessage('Sending password reset email...', 'success');
                    try {
                        const { error } = await supabase.auth.resetPasswordForEmail(this.user.email, {
                            redirectTo: window.location.origin + '/update-password.html', // Optional: where to redirect after reset
                        });
                        if (error) throw error;
                        this.showMessage('Password reset email sent! Please check your inbox.', 'success');
                    } catch (error) {
                        this.showMessage('Error sending reset email: ' + error.message, 'error');
                    } finally {
                        this.submitting = false;
                    }
                },

                showMessage(text, type) {
                    this.message.text = text;
                    this.message.type = type;
                    setTimeout(() => { this.message.text = ''; }, 4000);
                }
            }));
        });
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>