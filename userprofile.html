<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #1e3a8a; color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #1c347d; }
        .btn-secondary { background-color: #f59e0b; color: white; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #d97706; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800" x-data="userProfile">

    <header class="bg-white shadow-sm sticky top-0 z-50">
       <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-3">
                <img src="InvestSherpa logo.png" alt="InvestSherpa Logo" class="h-14 w-auto">
                <span class="text-2xl font-bold">
                    <span class="text-blue-900">Invest</span><span class="text-amber-500">Sherpa</span>
                </span>
            </a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium">Home</a>
                <a href="browselisting.html" class="text-gray-600 hover:text-blue-900 font-medium">Browse</a>
                <a href="#" class="text-gray-600 hover:text-blue-900 font-medium">Blog</a>
            </nav>
            <div id="user-actions" class="hidden md:flex items-center space-x-4">
                </div>
            <button @click="isMobileMenuOpen = !isMobileMenuOpen" class="md:hidden text-blue-900 text-2xl focus:outline-none"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <div x-show="isMobileMenuOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center text-center"
         @click.away="isMobileMenuOpen = false" x-cloak>
        
        <button @click="isMobileMenuOpen = false" class="absolute top-6 right-6 text-gray-800 focus:outline-none">
            <i class="fas fa-times text-3xl"></i>
        </button>

        <nav class="flex flex-col space-y-8 mb-8">
            <a href="index.html" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Home</a>
            <a href="browselisting.html" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Browse</a>
            <a href="#" @click="isMobileMenuOpen = false" class="text-2xl text-gray-800 hover:text-blue-900 font-bold">Blog</a>
        </nav>

        <div class="border-t w-1/2 my-4"></div>

        <div class="flex flex-col items-center space-y-4 mt-8" x-show="user">
            <span x-text="user.email" class="text-gray-800 font-bold text-lg"></span>
            <button @click="logout" class="font-semibold text-red-600 hover:underline text-lg">Logout</button>
        </div>
    </div>


    <main class="container mx-auto max-w-2xl px-6 py-12">
        <div x-show="!loading" x-cloak class="bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b pb-4">Your Profile</h2>

            <form @submit.prevent="updateProfile" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <div class="mt-1">
                        <input type="email" id="email" x-model="user.email" disabled class="w-full p-3 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>

                <div>
                    <label for="full_name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <div class="mt-1">
                        <input type="text" id="full_name" x-model="profile.full_name" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <div class="mt-1">
                        <input type="tel" id="phone" x-model="profile.phone" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                        <div class="mt-1">
                            <input type="text" id="city" x-model="profile.city" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                     <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">Pincode</label>
                        <div class="mt-1">
                            <input type="text" id="pincode" x-model="profile.pincode" maxlength="6" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                 <div>
                    <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                    <div class="mt-1">
                        <select id="state-select" x-model="profile.state" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                             <option value="" disabled>Select State</option>
                        </select>
                    </div>
                </div>
                <div x-show="message.text" :class="message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="p-4 rounded-md text-center" x-text="message.text"></div>

                <div class="flex flex-col-reverse sm:flex-row sm:justify-between sm:items-center pt-4 gap-4">
                    <a href="#" @click.prevent="resetPassword" class="text-sm text-center sm:text-left font-semibold text-blue-800 hover:underline">Reset Password</a>
                    
                    <button type="submit" :disabled="submitting" class="btn-primary font-bold py-2 px-6 rounded-lg shadow-md disabled:opacity-50 flex items-center justify-center w-full sm:w-auto">
                        <i x-show="submitting" class="fas fa-spinner fa-spin mr-2"></i>
                        <span x-text="submitting ? 'Saving...' : 'Save Changes'"></span>
                    </button>
                </div>
            </form>
        </div>

        <div x-show="loading" class="text-center py-20">
            <p class="text-xl text-gray-600">Loading your profile...</p>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const states = [ "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry" ];
        const stateSelect = document.getElementById('state-select');
        if (stateSelect) {
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        }

        const userActionsContainer = document.getElementById('user-actions');

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        function updateUserUI(user) {
            userActionsContainer.innerHTML = '';
            if (user) {
                userActionsContainer.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <a href="userprofile.html" class="text-gray-600 font-medium hover:text-blue-900 hover:underline text-sm">${user.email}</a>
                        <button id="logout-btn" class="font-semibold text-red-600 hover:underline">Logout</button>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
            } else {
                window.location.href = 'login.html';
            }
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('userProfile', () => ({
                loading: true,
                submitting: false,
                isMobileMenuOpen: false,
                user: null,
                profile: { full_name: '', phone: '', city: '', state: '', pincode: '' },
                message: { text: '', type: '' },

                async init() {
                    const { data: { session } } = await supabase.auth.getSession();
                    updateUserUI(session ? session.user : null);
                    if (!session) { return; }
                    this.user = session.user;
                    this.loadProfile();

                    supabase.auth.onAuthStateChange((_event, session) => {
                        updateUserUI(session ? session.user : null);
                    });
                },

                async loadProfile() {
                    this.loading = true;
                    try {
                        const { data, error } = await supabase
                            .from('user_profiles')
                            .select('full_name, phone, city, state, pincode')
                            .eq('id', this.user.id)
                            .single();
                        
                        if (error && error.code !== 'PGRST116') {
                           throw error;
                        }

                        if (data) {
                            this.profile = data;
                        }
                    } catch (error) {
                        this.showMessage('Error loading profile: ' + error.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async updateProfile() {
                    this.submitting = true;
                    this.message.text = '';
                    try {
                        const { error } = await supabase
                            .from('user_profiles')
                            .upsert({
                                id: this.user.id,
                                full_name: this.profile.full_name,
                                phone: this.profile.phone,
                                city: this.profile.city,
                                state: this.profile.state,
                                pincode: this.profile.pincode,
                            })
                            .select()
                            .single();
                        
                        if (error) throw error;

                        this.showMessage('Profile updated successfully!', 'success');
                    } catch (error) {
                        this.showMessage('Error updating profile: ' + error.message, 'error');
                    } finally {
                        this.submitting = false;
                    }
                },

                async resetPassword() {
                    if (!confirm('Are you sure you want to send a password reset link to your email?')) return;
                    
                    this.submitting = true;
                    this.showMessage('Sending password reset email...', 'success');
                    try {
                        const { error } = await supabase.auth.resetPasswordForEmail(this.user.email, {
                            redirectTo: window.location.origin,
                        });
                        if (error) throw error;
                        this.showMessage('Password reset email sent! Please check your inbox.', 'success');
                    } catch (error) {
                        this.showMessage('Error sending reset email: ' + error.message, 'error');
                    } finally {
                        this.submitting = false;
                    }
                },
                
                async logout() {
                    await supabase.auth.signOut();
                },

                showMessage(text, type) {
                    this.message.text = text;
                    this.message.type = type;
                    setTimeout(() => { this.message.text = ''; }, 4000);
                }
            }));
        });
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>