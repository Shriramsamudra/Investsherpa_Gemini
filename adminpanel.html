<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - InvestSherpa.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #1e3a8a; color: white; transition: background-color 0.3s ease; }
        .btn-danger { background-color: #dc2626; color: white; transition: background-color 0.3s ease; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800" x-data="adminPanel()">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        </header>

    <div class="flex">
        <aside class="w-64 bg-white shadow-md h-screen sticky top-[76px]">
            </aside>

        <main class="flex-1 p-8">
            <h1 class="text-3xl font-bold text-blue-900 mb-6">Pending Professional Sign-ups</h1>
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold">Company / Professional</th>
                                <th class="p-4 font-semibold">Contact Email</th>
                                <th class="p-4 font-semibold">Location</th>
                                <th class="p-4 font-semibold">Submitted On</th>
                                <th class="p-4 font-semibold text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-profiles-tbody">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div x-show="isModalOpen" @keydown.escape.window="isModalOpen = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-cloak>
        <div @click.outside="isModalOpen = false" class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-blue-900">Review Professional Profile</h2>
                <button @click="isModalOpen = false" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <div class="p-8 overflow-y-auto">
                <div id="modal-content"></div>
            </div>
            
            <div class="p-6 bg-gray-50 border-t mt-auto">
                <div x-data="{ showRejectionInput: false }">
                    <div x-show="showRejectionInput" class="mb-4">
                        <label for="rejection" class="block text-sm font-medium text-gray-700 mb-1">Reason for Rejection (required)</label>
                        <input type="text" id="rejection" x-model="rejectionReason" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="flex justify-end items-center space-x-4">
                        <button @click="showRejectionInput = !showRejectionInput" x-text="showRejectionInput ? 'Cancel' : 'Reject'" class="font-semibold"></button>
                        <button x-show="showRejectionInput" @click="rejectProfile()" :disabled="!rejectionReason" class="btn-danger font-bold py-2 px-6 rounded-lg disabled:opacity-50">Confirm Rejection</button>
                        <button @click="approveProfile()" class="btn-primary font-bold py-2 px-8 rounded-lg">Approve</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        const SUPABASE_URL = 'https://fjqvfzlfhhkfohprlqhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcXZmemxmaGhrZm9ocHJscWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODYyNzAsImV4cCI6MjA3MjA2MjI3MH0.QB_QA-aKeoaxswUpnjBXxerzc-z0tSxerQCQ-hHyLXQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function adminPanel() {
            return {
                isModalOpen: false,
                rejectionReason: '',
                currentProfile: null,
                profiles: [],

                async init() {
                    // TODO: Add a check for admin role here
                    await this.fetchPendingProfiles();
                },

                async fetchPendingProfiles() {
                    const { data, error } = await supabase
                        .from('professional_profiles')
                        .select('*, user_profiles(full_name)')
                        .eq('status', 'pending')
                        .order('created_at', { ascending: true });

                    if (error) {
                        console.error('Error fetching pending profiles:', error);
                        return;
                    }
                    this.profiles = data;
                    this.renderTable();
                },
                
                renderTable() {
                    const tbody = document.getElementById('pending-profiles-tbody');
                    tbody.innerHTML = '';
                    this.profiles.forEach((profile, index) => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="p-4 font-bold">${profile.business_name}</td>
                            <td class="p-4">${profile.email}</td>
                            <td class="p-4">${profile.city || 'N/A'}</td>
                            <td class="p-4">${new Date(profile.created_at).toLocaleDateString()}</td>
                            <td class="p-4 text-center">
                                <button @click="openReviewModal(${index})" class="bg-blue-600 text-white py-1 px-4 rounded-lg font-semibold hover:bg-blue-700">
                                    <i class="fas fa-search-plus mr-1"></i> Review
                                </button>
                            </td>`;
                        tbody.appendChild(tr);
                    });
                },

                openReviewModal(index) {
                    this.currentProfile = this.profiles[index];
                    const modalContent = document.getElementById('modal-content');
                    modalContent.innerHTML = `
                        <h3 class="font-bold text-lg">Business Name: ${this.currentProfile.business_name}</h3>
                        <p><strong>Submitted by:</strong> ${this.currentProfile.user_profiles.full_name}</p>
                        <p><strong>Contact:</strong> ${this.currentProfile.email}</p>
                        <p><strong>About:</strong> ${this.currentProfile.about || 'Not provided.'}</p>
                    `;
                    this.isModalOpen = true;
                },

                async approveProfile() {
                    if (!this.currentProfile) return;
                    const { error } = await supabase
                        .from('professional_profiles')
                        .update({ status: 'approved', approved_at: new Date() })
                        .eq('id', this.currentProfile.id);
                    
                    if (error) {
                        alert(`Error approving profile: ${error.message}`);
                    } else {
                        alert('Profile approved successfully!');
                        this.isModalOpen = false;
                        await this.fetchPendingProfiles();
                    }
                },

                async rejectProfile() {
                    if (!this.currentProfile || !this.rejectionReason) return;
                     const { error } = await supabase
                        .from('professional_profiles')
                        .update({ status: 'rejected', rejection_reason: this.rejectionReason })
                        .eq('id', this.currentProfile.id);
                    
                    if (error) {
                        alert(`Error rejecting profile: ${error.message}`);
                    } else {
                        alert('Profile rejected.');
                        this.isModalOpen = false;
                        this.rejectionReason = '';
                        await this.fetchPendingProfiles();
                    }
                }
            };
        }
        
        // Expose the function to the global scope for Alpine.js
        window.adminPanel = adminPanel;
    </script>
</body>
</html>